---
parameters:
  - name: environment
    type: string
    values:
      - fat
      - prd
      - sit
      - uat
  - name: location
    type: string
    default: westeurope
  - name: logicalEnvironment
    type: string

steps:
  - template: steps/get-subscription-id.yml@templates
    parameters:
      serviceConnectionName: sub-customer-${{ parameters.environment }}-t1-01-deploy
      subscriptionName: sub-customer-${{ parameters.environment }}-t1-01

  - template: steps/get-short-location.yml@templates
    parameters:
      location: ${{ parameters.location }}

  - task: AzurePowerShell@5
    displayName: Publish
    inputs:
      azureSubscription: sub-customer-${{ parameters.environment }}-t1-01-deploy
      pwsh: true
      azurePowerShellVersion: LatestVersion
      ScriptType: FilePath
      ScriptPath: $(System.DefaultWorkingDirectory)/scripts/publish.ps1
      ScriptArguments: |
        -DataFactoryCodePath $(System.DefaultWorkingDirectory)/src `
        -ResourceGroupName "rg-ct-${{ parameters.environment }}-$(shortLocation)-${{ parameters.logicalEnvironment }}gup" `
        -DataFactoryName "adf-ct-${{ parameters.environment }}-$(shortLocation)-${{ parameters.logicalEnvironment }}gup" `
        -Location "${{ parameters.location }}" `
        -CreateNewInstance $false `
        -DeleteNotInSource $true `
        -DoNotDeleteExcludedObjects $false `
        -StageConfigFile "$(System.DefaultWorkingDirectory)/.config/config.csv" `
        -FilterTextFile "$(System.DefaultWorkingDirectory)/.config/filter.txt"
