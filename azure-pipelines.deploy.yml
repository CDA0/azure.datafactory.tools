---
parameters:
  - name: deploySql
    type: boolean
  - name: environment
    type: string
    values:
      - fat
      - prd
      - sit
      - uat
  - name: location
    type: string
    default: westeurope
  - name: logicalEnvironment
    type: string

steps:
  - template: steps/get-subscription-id.yml@templates
    parameters:
      serviceConnectionName: sub-customer-${{ parameters.environment }}-t1-01-deploy
      subscriptionName: sub-customer-${{ parameters.environment }}-t1-01

  - template: steps/get-short-location.yml@templates
    parameters:
      location: ${{ parameters.location }}

  - ${{ if eq(parameters.deploySql, true) }}:
      - task: AzureCLI@2
        inputs:
          azureSubscription: sub-customer-${{ parameters.environment }}-t1-01-deploy
          scriptType: bash
          scriptLocation: inlineScript
          inlineScript: |
            set -euo pipefail

            az account set -s sub-customer-${{ parameters.environment }}-t1-01

            keyVault="kv-ct-${{ parameters.environment }}-$(shortLocation)-gupcom"
            sqlServerFqdn=$(az keyvault secret show -n sql-server-fqdn --vault-name $keyVault --query value -o tsv)
            sqlServerPassword=$(az keyvault secret show -n sql-server-password --vault-name $keyVault --query value -o tsv)
            sqlDatabaseName=sdb-ct-${{ parameters.environment }}-$(shortLocation)-${{ parameters.logicalEnvironment }}gup

            while IFS='' read -r line || [[ -n "$line" ]]; do
              echo $(System.DefaultWorkingDirectory)/.config/sql/$line
              cat $(System.DefaultWorkingDirectory)/.config/sql/$line
              pwsh -c $(System.DefaultWorkingDirectory)/scripts/run-sql.ps1 "$sqlServerFqdn" "sqladmin" "$sqlServerPassword" "$sqlDatabaseName" "$(System.DefaultWorkingDirectory)/.config/sql/$line"
            done < $(System.DefaultWorkingDirectory)/.config/sql.txt
        displayName: Run SQL commands

  - ${{ if ne(parameters.logicalEnvironment, 'dev') }}:
      - task: AzurePowerShell@5
        displayName: Publish
        inputs:
          azureSubscription: sub-customer-${{ parameters.environment }}-t1-01-deploy
          pwsh: true
          azurePowerShellVersion: LatestVersion
          ScriptType: FilePath
          ScriptPath: $(System.DefaultWorkingDirectory)/scripts/publish.ps1
          ScriptArguments: |
            -DataFactoryCodePath $(System.DefaultWorkingDirectory)/src `
            -ResourceGroupName "rg-ct-${{ parameters.environment }}-$(shortLocation)-${{ parameters.logicalEnvironment }}gup" `
            -DataFactoryName "adf-ct-${{ parameters.environment }}-$(shortLocation)-${{ parameters.logicalEnvironment }}gup" `
            -Location "${{ parameters.location }}" `
            -CreateNewInstance $false `
            -DeleteNotInSource $true `
            -DoNotDeleteExcludedObjects $false `
            -StageConfigFile "$(System.DefaultWorkingDirectory)/.config/config.csv" `
            -FilterTextFile "$(System.DefaultWorkingDirectory)/.config/filter.txt"
