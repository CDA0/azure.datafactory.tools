{
	"name": "p_DPDB-CDI-DPDB_ADVISER_FIRM_STG",
	"properties": {
		"description": "Author: Rizaul Kamal\nDate: 16/05/2023\nDescription: Extracts Adviser Frim data from DPDB",
		"activities": [
			{
				"name": "cp-TD_DPDB_ADVISER_FIRM_STG",
				"type": "Copy",
				"dependsOn": [],
				"policy": {
					"timeout": "0.01:00:00",
					"retry": 1,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "OracleSource",
						"oracleReaderQuery": "with PARTY_DETAILS\nas\n(select P.ORGANISATION_NAME,\n        PR.PARTY_ROLE_ID,\n        PR.PARTY_ROLE_TYPE_ID,\n        OPR.STATUS,\n        OPR.FIRM_REFERENCE_NUMBER,\n        OPR.REGULATORY_STATUS_ID,\n        OPR.REGULATION_TYPE_ID\n   from DPARTNER.PARTY P\n  inner join DPARTNER.PARTY_ROLE PR\n     on (PR.PARTY_ID = P.PARTY_ID)\n  inner join DPARTNER.ORGANISATION_PARTY_ROLE OPR\n     on (OPR.PARTY_ROLE_ID = PR.PARTY_ROLE_ID)\n  where PR.PARTY_ROLE_TYPE_ID in ('adv_firm', 'par_org', 'os_firm', 'sp_firm')\n    and PR.PARTY_ROLE_ID in\n          (select distinct\n                  PRR.PARTY_ROLE_ID \n             from DPARTNER.COMMISSION_ACCOUNT CA\n            inner join DPARTNER.LEGACY_ACCOUNT_DETAIL LAD\n               on (CA.COMMISSION_ACCOUNT_ID = LAD.COMMISSION_ACCOUNT_ID)\n            inner join DPARTNER.PARTY_ROLE_RELATIONSHIP PRR\n               on (PRR.RELATED_PARTY_ROLE_ID = CA.PARTY_ROLE_ID)\n            where relationship_type_id = 'rel_afoff'\n          )\n),\nHEAD_OFFICE\nas\n(select PRR.PARTY_ROLE_ID,\n        PRR.RELATED_PARTY_ROLE_ID as HEAD_OFFICE_PARTY_ROLE_ID\n   from DPARTNER.PARTY_ROLE_RELATIONSHIP PRR\n  inner join DPARTNER.PARTY_ROLE PR\n     on (PRR.RELATED_PARTY_ROLE_ID = PR.PARTY_ROLE_ID)\n  where PRR.RELATIONSHIP_TYPE_ID = 'rel_afoff'\n    and PRR.END_DATE is null\n    and PR.PARTY_ROLE_TYPE_ID = 'head_off'\n),\nHO_ADDRESS\nas\n(select ADDRESS.PARTY_ROLE_ID,\n        ADDRESS.ADDRESS_LINE_1,\n        ADDRESS.ADDRESS_LINE_2,\n        ADDRESS.ADDRESS_LINE_3,\n        ADDRESS.ADDRESS_LINE_4,\n        ADDRESS.POSTCODE\n   from (select CPR.PARTY_ROLE_ID,\n                trim(PA.ADDRESS_LINE_1) as ADDRESS_LINE_1,\n                trim(PA.ADDRESS_LINE_2) as ADDRESS_LINE_2,\n                trim(PA.ADDRESS_LINE_3) as ADDRESS_LINE_3,\n                trim(PA.ADDRESS_LINE_4) as ADDRESS_LINE_4,\n                trim(PA.POSTCODE) as POSTCODE,\n                row_number() over (partition by CPR.PARTY_ROLE_ID\n                                       order by CPR.UPDATED_DATE desc) RN\n           from DPARTNER.PARTY_ROLE PR\n          inner join DPARTNER.CONTACT_POINT_ROLE CPR\n             on (PR.PARTY_ROLE_ID = CPR.PARTY_ROLE_ID)  \n          inner join DPARTNER.CONTACT_POINT CP\n             on (CP.CONTACT_POINT_ID = CPR.CONTACT_POINT_ID)\n          inner join DPARTNER.POSTAL_ADDRESS PA\n             on (PA.CONTACT_POINT_ID  = CP.CONTACT_POINT_ID)\n          where CPR.END_DATE is null\n            and CP.CONTACT_POINT_TYPE_ID = 'cp_addr'\n            and nvl(CPR.CONTACT_POINT_ROLE_TYPE_ID, 'A') != 'cpr_rig'\n            and PR.PARTY_ROLE_TYPE_ID = 'head_off') ADDRESS\n  where ADDRESS.RN = 1\n),\nPARTY_ROLE_NETWORK\nas\n(select nvl(STAGE2.PARTY_ROLE_ID, PRR.PARTY_ROLE_ID) as PARTY_ROLE_ID,\n       PRR.RELATED_PARTY_ROLE_ID\n  from DPARTNER.PARTY_ROLE_RELATIONSHIP PRR\n  left outer join (select PARTY_ROLE_ID,\n                          RELATED_PARTY_ROLE_ID\n                     from DPARTNER.PARTY_ROLE_RELATIONSHIP\n                    where RELATIONSHIP_TYPE_ID = 'rel_netmem'\n                      and END_DATE IS NULL\n                      and DEFAULT_REPORT_RELATIONSHIP = 'Y'\n                      and RELATED_PARTY_ROLE_ID in\n                           (select PARTY_ROLE_ID\n                                   from DPARTNER.ORGANISATION_PARTY_ROLE\n                                   where REGULATION_TYPE_ID = 'rt_apprep'\n                                     and status = 'A'\n                           )\n                  ) STAGE2\n    on (STAGE2.RELATED_PARTY_ROLE_ID = PRR.PARTY_ROLE_ID)\n  where PRR.RELATIONSHIP_TYPE_ID = 'rel_netmem'\n    and PRR.END_DATE IS NULL\n    and PRR.DEFAULT_REPORT_RELATIONSHIP = 'Y'\n    and PRR.RELATED_PARTY_ROLE_ID in\n          (select PARTY_ROLE_ID\n             from DPARTNER.ORGANISATION_PARTY_ROLE\n            where REGULATION_TYPE_ID = 'rt_apprep'\n              and status = 'A'\n          )\n),\nAUTHORISATION\nas\n(select PARTY_ROLE_ID,\n        PROD_GRP_ID \n   from DPARTNER.PRODUCT_AUTHORISATION\n  where END_DATE is null \n    and PROD_GRP_ID in (10002, 10003, 10004)\n),\nROLE_PERMISSION\nas\n(select PERMISSION_TYPE_ID,\n        PARTY_ROLE_ID \n   from DPARTNER.PARTY_ROLE_PERMISSIONS\n  where END_DATE is null\n    and PERMISSION_TYPE_ID = 'prp_penstrans'\n),\nHO_EMAIL\nas\n(select EMAIL.PARTY_ROLE_ID,\n        EMAIL.EMAIL_URL_ADDRESS\n   from (select CPR.PARTY_ROLE_ID,\n                trim(EUA.EMAIL_URL_ADDRESS) as EMAIL_URL_ADDRESS,\n                row_number() over (partition by CPR.PARTY_ROLE_ID\n                                       order by CPR.UPDATED_DATE desc) RN\n           from DPARTNER.CONTACT_POINT_ROLE CPR\n          inner join DPARTNER.CONTACT_POINT CP\n             on (CP.CONTACT_POINT_ID = CPR.CONTACT_POINT_ID)\n          inner join DPARTNER.EMAIL_URL_ADDRESS EUA\n             on (EUA.CONTACT_POINT_ID = CP.CONTACT_POINT_ID)\n          inner join DPARTNER.PARTY_ROLE PR\n             on (PR.PARTY_ROLE_ID = CPR.PARTY_ROLE_ID )\n          where CPR.END_DATE is null\n            and CP.CONTACT_POINT_TYPE_ID = 'cp_email'\n            and PR.PARTY_ROLE_TYPE_ID = 'head_off') EMAIL\n  where EMAIL.RN = 1\n),\nHO_PHONE\nas\n(select PHONE.PARTY_ROLE_ID,\n        PHONE.PHONE_FAX_NUMBER\n   from (select CPR.PARTY_ROLE_ID,\n                PFN.PHONE_FAX_NUMBER,\n                row_number() over (partition by CPR.PARTY_ROLE_ID\n                                       order by CPR.UPDATED_DATE desc) RN\n           from DPARTNER.CONTACT_POINT_ROLE CPR\n          inner join DPARTNER.CONTACT_POINT CP\n             on (CP.CONTACT_POINT_ID = CPR.CONTACT_POINT_ID)\n          inner join DPARTNER.PHONE_FAX_NUMBER PFN\n             on (PFN.CONTACT_POINT_ID = CP.CONTACT_POINT_ID)\n          inner join DPARTNER.PARTY_ROLE PR\n             on (PR.PARTY_ROLE_ID = CPR.PARTY_ROLE_ID )\n          where CPR.END_DATE is null\n            and CP.CONTACT_POINT_TYPE_ID = 'cp_phone'\n            and PR.PARTY_ROLE_TYPE_ID = 'head_off') PHONE\n  where PHONE.RN = 1\n)\nselect PD.PARTY_ROLE_ID,\n       PD.ORGANISATION_NAME, \n       PD.FIRM_REFERENCE_NUMBER,\n       PD.STATUS, \n       PD.REGULATORY_STATUS_ID, \n\t   PD.PARTY_ROLE_TYPE_ID,\n       nvl2(AIA.PROD_GRP_ID, 1, 0) as PERM_INVESTMENT_ADVICE,\n       nvl2(AMA.PROD_GRP_ID, 1, 0) as PERM_MORTGAGE_ADVICE,\n       nvl2(APA.PROD_GRP_ID, 1, 0) as PERM_INSURANCE_ADVICE,\n       nvl2(RP.PERMISSION_TYPE_ID, 1, 0) as PERM_PENSION_ADVICE,\n\t   HA.ADDRESS_LINE_1,\n       HA.ADDRESS_LINE_2,\n       HA.ADDRESS_LINE_3,\n       HA.ADDRESS_LINE_4,\n       HA.POSTCODE,\n\t   HE.EMAIL_URL_ADDRESS,\n       HP.PHONE_FAX_NUMBER\n  from PARTY_DETAILS PD\n  left outer join HEAD_OFFICE HO\n    on (PD.PARTY_ROLE_ID = HO.PARTY_ROLE_ID)\n  left outer join HO_ADDRESS HA\n    on HA.PARTY_ROLE_ID = HO.HEAD_OFFICE_PARTY_ROLE_ID\n  left outer join PARTY_ROLE_NETWORK PRN\n    on (PRN.RELATED_PARTY_ROLE_ID = PD.PARTY_ROLE_ID)\n  left outer join AUTHORISATION AIA\n    on (    AIA.PROD_GRP_ID = 10004\n        and AIA.PARTY_ROLE_ID = case\n                                  when PD.REGULATION_TYPE_ID = 'rt_apprep' then\n                                    PRN.PARTY_ROLE_ID\n                                else\n                                  PD.PARTY_ROLE_ID\n                                end)\n  left outer join AUTHORISATION AMA\n    on (    AMA.PROD_GRP_ID = 10003\n        and AMA.PARTY_ROLE_ID = case\n                                  when PD.REGULATION_TYPE_ID = 'rt_apprep' then\n                                    PRN.PARTY_ROLE_ID\n                                else\n                                  PD.PARTY_ROLE_ID\n                                end)\n  left outer join AUTHORISATION APA\n    on (    APA.PROD_GRP_ID = 10002\n        and APA.PARTY_ROLE_ID = case\n                                  when PD.REGULATION_TYPE_ID = 'rt_apprep' then\n                                    PRN.PARTY_ROLE_ID\n                                else\n                                  PD.PARTY_ROLE_ID\n                                end)\n  left outer join ROLE_PERMISSION RP\n    on (RP.PARTY_ROLE_ID = case\n                             when PD.REGULATION_TYPE_ID = 'rt_apprep' then\n                               PRN.PARTY_ROLE_ID\n                           else\n                             PD.PARTY_ROLE_ID\n                           end)\n  left outer join HO_PHONE HP\n    on (HP.PARTY_ROLE_ID = HO.HEAD_OFFICE_PARTY_ROLE_ID)\n  left outer join HO_EMAIL HE\n    on (HE.PARTY_ROLE_ID = HO.HEAD_OFFICE_PARTY_ROLE_ID)\n",
						"partitionOption": "None",
						"queryTimeout": "02:00:00"
					},
					"sink": {
						"type": "AzureSqlSink",
						"writeBehavior": "insert",
						"sqlWriterUseTableLock": false
					},
					"enableStaging": false,
					"enableSkipIncompatibleRow": true,
					"translator": {
						"type": "TabularTranslator",
						"mappings": [
							{
								"source": {
									"name": "PARTY_ROLE_ID",
									"type": "String"
								},
								"sink": {
									"name": "PARTY_ROLE_ID",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "ORGANISATION_NAME",
									"type": "String"
								},
								"sink": {
									"name": "ORGANISATION_NAME",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "FIRM_REFERENCE_NUMBER",
									"type": "String"
								},
								"sink": {
									"name": "FIRM_REFERENCE_NUMBER",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "STATUS",
									"type": "String"
								},
								"sink": {
									"name": "STATUS",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "REGULATORY_STATUS_ID",
									"type": "String"
								},
								"sink": {
									"name": "REGULATORY_STATUS_ID",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "PARTY_ROLE_TYPE_ID",
									"type": "String"
								},
								"sink": {
									"name": "PARTY_ROLE_TYPE_ID",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "PERM_INVESTMENT_ADVICE",
									"type": "Double"
								},
								"sink": {
									"name": "PERM_INVESTMENT_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								}
							},
							{
								"source": {
									"name": "PERM_MORTGAGE_ADVICE",
									"type": "Double"
								},
								"sink": {
									"name": "PERM_MORTGAGE_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								}
							},
							{
								"source": {
									"name": "PERM_INSURANCE_ADVICE",
									"type": "Double"
								},
								"sink": {
									"name": "PERM_INSURANCE_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								}
							},
							{
								"source": {
									"name": "PERM_PENSION_ADVICE",
									"type": "Double"
								},
								"sink": {
									"name": "PERM_PENSION_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								}
							},
							{
								"source": {
									"name": "ADDRESS_LINE_1",
									"type": "String"
								},
								"sink": {
									"name": "ADDRESS_LINE_1",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "ADDRESS_LINE_2",
									"type": "String"
								},
								"sink": {
									"name": "ADDRESS_LINE_2",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "ADDRESS_LINE_3",
									"type": "String"
								},
								"sink": {
									"name": "ADDRESS_LINE_3",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "ADDRESS_LINE_4",
									"type": "String"
								},
								"sink": {
									"name": "ADDRESS_LINE_4",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "POSTCODE",
									"type": "String"
								},
								"sink": {
									"name": "POSTCODE",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "EMAIL_URL_ADDRESS",
									"type": "String"
								},
								"sink": {
									"name": "EMAIL_URL_ADDRESS",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "PHONE_FAX_NUMBER",
									"type": "String"
								},
								"sink": {
									"name": "PHONE_FAX_NUMBER",
									"type": "String",
									"physicalType": "varchar"
								}
							}
						],
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "ds_DPDB",
						"type": "DatasetReference",
						"parameters": {
							"SCHEMA": "DPARTNER",
							"TABLE": "VARIOUS"
						}
					}
				],
				"outputs": [
					{
						"referenceName": "ds_ASQLDB",
						"type": "DatasetReference",
						"parameters": {
							"SCHEMA": "STAGE_LOAD",
							"TABLE_NAME": "TD_DPDB_ADVISER_FIRM_STG",
							"ENVIRONMENT": {
								"value": "@pipeline().globalParameters.ENVIRONMENT",
								"type": "Expression"
							},
							"LOGICAL_ENVIRONMENT": {
								"value": "@pipeline().globalParameters.LOGICAL_ENVIRONMENT",
								"type": "Expression"
							},
							"SHORT_LOCATION": {
								"value": "@pipeline().globalParameters.SHORT_LOCATION",
								"type": "Expression"
							}
						}
					}
				]
			},
			{
				"name": "cp-DPDB_ADVISER_FIRM_STG_Upsert",
				"description": "Add any delta changes to the target",
				"type": "Copy",
				"dependsOn": [
					{
						"activity": "cp-TD_DPDB_ADVISER_FIRM_STG",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.01:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "AzureSqlSource",
						"additionalColumns": [
							{
								"name": "CREATE_USER_ID",
								"value": {
									"value": "@pipeline().Pipeline",
									"type": "Expression"
								}
							}
						],
						"sqlReaderQuery": "select TDAFS.PARTY_ROLE_ID,\r\n       TDAFS.ORGANISATION_NAME,\r\n       TDAFS.FIRM_REFERENCE_NUMBER,\r\n       TDAFS.STATUS,\r\n       TDAFS.REGULATORY_STATUS_ID,\r\n       TDAFS.PARTY_ROLE_TYPE_ID,\r\n       TDAFS.PERM_INVESTMENT_ADVICE,\r\n       TDAFS.PERM_MORTGAGE_ADVICE,\r\n       TDAFS.PERM_INSURANCE_ADVICE,\r\n       TDAFS.PERM_PENSION_ADVICE,\r\n       TDAFS.ADDRESS_LINE_1,\r\n       TDAFS.ADDRESS_LINE_2,\r\n       TDAFS.ADDRESS_LINE_3,\r\n       TDAFS.ADDRESS_LINE_4,\r\n       TDAFS.POSTCODE,\r\n       TDAFS.EMAIL_URL_ADDRESS,\r\n       TDAFS.PHONE_FAX_NUMBER,\r\n       TDAFS.RECORD_UPDATE_IND,\r\n       0 as RECORD_DELETE_IND,\r\n       cast(sysdatetimeoffset() at time zone 'GMT Standard Time' as datetime) as UPDATE_DATE_TIME\r\n  from (select PARTY_ROLE_ID,\r\n               ORGANISATION_NAME,\r\n               FIRM_REFERENCE_NUMBER,\r\n               STATUS,\r\n               REGULATORY_STATUS_ID,\r\n               PARTY_ROLE_TYPE_ID,\r\n               PERM_INVESTMENT_ADVICE,\r\n               PERM_MORTGAGE_ADVICE,\r\n               PERM_INSURANCE_ADVICE,\r\n               PERM_PENSION_ADVICE,\r\n               ADDRESS_LINE_1,\r\n               ADDRESS_LINE_2,\r\n               ADDRESS_LINE_3,\r\n               ADDRESS_LINE_4,\r\n               POSTCODE,\r\n               EMAIL_URL_ADDRESS,\r\n               PHONE_FAX_NUMBER,\r\n               convert(nvarchar(32), HashBytes('SHA2_256', concat(PARTY_ROLE_ID,\r\n                                                                  ORGANISATION_NAME,\r\n                                                                  FIRM_REFERENCE_NUMBER,\r\n                                                                  STATUS,\r\n                                                                  REGULATORY_STATUS_ID,\r\n                                                                  PARTY_ROLE_TYPE_ID,\r\n                                                                  PERM_INVESTMENT_ADVICE,\r\n                                                                  PERM_MORTGAGE_ADVICE,\r\n                                                                  PERM_INSURANCE_ADVICE,\r\n                                                                  PERM_PENSION_ADVICE,\r\n                                                                  ADDRESS_LINE_1,\r\n                                                                  ADDRESS_LINE_2,\r\n                                                                  ADDRESS_LINE_3,\r\n                                                                  ADDRESS_LINE_4,\r\n                                                                  POSTCODE,\r\n                                                                  EMAIL_URL_ADDRESS,\r\n                                                                  PHONE_FAX_NUMBER)), 2) as RECORD_UPDATE_IND\r\n          from STAGE_LOAD.TD_DPDB_ADVISER_FIRM_STG \r\n       ) TDAFS\r\n  left outer join STAGE_CDI.DPDB_ADVISER_FIRM_STG DAFS\r\n    on (    TDAFS.PARTY_ROLE_ID = DAFS.PARTY_ROLE_ID\r\n        and TDAFS.RECORD_UPDATE_IND = DAFS.RECORD_UPDATE_IND)\r\n where DAFS.PARTY_ROLE_ID is null\r\n",
						"queryTimeout": "02:00:00",
						"partitionOption": "None"
					},
					"sink": {
						"type": "AzureSqlSink",
						"writeBehavior": "upsert",
						"upsertSettings": {
							"useTempDB": true,
							"keys": [
								"PARTY_ROLE_ID"
							]
						},
						"sqlWriterUseTableLock": false,
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"mappings": [
							{
								"source": {
									"name": "PARTY_ROLE_ID",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "PARTY_ROLE_ID",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "ORGANISATION_NAME",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "ORGANISATION_NAME",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "FIRM_REFERENCE_NUMBER",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "FIRM_REFERENCE_NUMBER",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "STATUS",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "STATUS",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "REGULATORY_STATUS_ID",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "REGULATORY_STATUS_ID",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "PARTY_ROLE_TYPE_ID",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "PARTY_ROLE_TYPE_ID",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "PERM_INVESTMENT_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								},
								"sink": {
									"name": "PERM_INVESTMENT_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								}
							},
							{
								"source": {
									"name": "PERM_MORTGAGE_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								},
								"sink": {
									"name": "PERM_MORTGAGE_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								}
							},
							{
								"source": {
									"name": "PERM_INSURANCE_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								},
								"sink": {
									"name": "PERM_INSURANCE_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								}
							},
							{
								"source": {
									"name": "PERM_PENSION_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								},
								"sink": {
									"name": "PERM_PENSION_ADVICE",
									"type": "Boolean",
									"physicalType": "bit"
								}
							},
							{
								"source": {
									"name": "ADDRESS_LINE_1",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "ADDRESS_LINE_1",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "ADDRESS_LINE_2",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "ADDRESS_LINE_2",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "ADDRESS_LINE_3",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "ADDRESS_LINE_3",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "ADDRESS_LINE_4",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "ADDRESS_LINE_4",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "POSTCODE",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "POSTCODE",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "EMAIL_URL_ADDRESS",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "EMAIL_URL_ADDRESS",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "PHONE_FAX_NUMBER",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "PHONE_FAX_NUMBER",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "RECORD_UPDATE_IND",
									"type": "String",
									"physicalType": "nvarchar"
								},
								"sink": {
									"name": "RECORD_UPDATE_IND",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "RECORD_DELETE_IND",
									"type": "Int32",
									"physicalType": "int"
								},
								"sink": {
									"name": "RECORD_DELETE_IND",
									"type": "Decimal",
									"physicalType": "decimal",
									"scale": 0,
									"precision": 1
								}
							},
							{
								"source": {
									"name": "CREATE_USER_ID",
									"type": "String"
								},
								"sink": {
									"name": "CREATE_USER_ID",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "UPDATE_DATE_TIME",
									"type": "DateTime",
									"physicalType": "datetime"
								},
								"sink": {
									"name": "UPDATE_DATE_TIME",
									"type": "DateTime",
									"physicalType": "datetime2"
								}
							}
						],
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "ds_ASQLDB",
						"type": "DatasetReference",
						"parameters": {
							"SCHEMA": "STAGE_LOAD",
							"TABLE_NAME": "TD_DPDB_ADVISER_FIRM_STG",
							"ENVIRONMENT": {
								"value": "@pipeline().globalParameters.ENVIRONMENT",
								"type": "Expression"
							},
							"LOGICAL_ENVIRONMENT": {
								"value": "@pipeline().globalParameters.LOGICAL_ENVIRONMENT",
								"type": "Expression"
							},
							"SHORT_LOCATION": {
								"value": "@pipeline().globalParameters.SHORT_LOCATION",
								"type": "Expression"
							}
						}
					}
				],
				"outputs": [
					{
						"referenceName": "ds_ASQLDB",
						"type": "DatasetReference",
						"parameters": {
							"SCHEMA": "STAGE_CDI",
							"TABLE_NAME": "DPDB_ADVISER_FIRM_STG",
							"ENVIRONMENT": {
								"value": "@pipeline().globalParameters.ENVIRONMENT",
								"type": "Expression"
							},
							"LOGICAL_ENVIRONMENT": {
								"value": "@pipeline().globalParameters.LOGICAL_ENVIRONMENT",
								"type": "Expression"
							},
							"SHORT_LOCATION": {
								"value": "@pipeline().globalParameters.SHORT_LOCATION",
								"type": "Expression"
							}
						}
					}
				]
			},
			{
				"name": "cp-DPDB_ADVISER_FIRM_STG_Del",
				"description": "Logically mark records no longer available in the source",
				"type": "Copy",
				"dependsOn": [
					{
						"activity": "cp-DPDB_ADVISER_FIRM_STG_Upsert",
						"dependencyConditions": [
							"Succeeded"
						]
					}
				],
				"policy": {
					"timeout": "0.01:00:00",
					"retry": 0,
					"retryIntervalInSeconds": 30,
					"secureOutput": false,
					"secureInput": false
				},
				"userProperties": [],
				"typeProperties": {
					"source": {
						"type": "AzureSqlSource",
						"sqlReaderQuery": "select DAFS.PARTY_ROLE_ID,\r\n       1 as RECORD_DELETE_IND,\r\n       cast(sysdatetimeoffset() at time zone 'GMT Standard Time' as datetime) as UPDATE_DATE_TIME\r\n  from STAGE_CDI.DPDB_ADVISER_FIRM_STG DAFS\r\n  left outer join STAGE_LOAD.TD_DPDB_ADVISER_FIRM_STG TDAFS\r\n    on (TDAFS.PARTY_ROLE_ID = DAFS.PARTY_ROLE_ID)\r\n where TDAFS.PARTY_ROLE_ID is NULL",
						"queryTimeout": "02:00:00",
						"partitionOption": "None"
					},
					"sink": {
						"type": "AzureSqlSink",
						"writeBehavior": "upsert",
						"upsertSettings": {
							"useTempDB": true,
							"keys": [
								"PARTY_ROLE_ID"
							]
						},
						"sqlWriterUseTableLock": false,
						"disableMetricsCollection": false
					},
					"enableStaging": false,
					"translator": {
						"type": "TabularTranslator",
						"mappings": [
							{
								"source": {
									"name": "PARTY_ROLE_ID",
									"type": "String",
									"physicalType": "varchar"
								},
								"sink": {
									"name": "PARTY_ROLE_ID",
									"type": "String",
									"physicalType": "varchar"
								}
							},
							{
								"source": {
									"name": "RECORD_DELETE_IND",
									"type": "Int32",
									"physicalType": "int"
								},
								"sink": {
									"name": "RECORD_DELETE_IND",
									"type": "Decimal",
									"physicalType": "decimal",
									"scale": 0,
									"precision": 1
								}
							},
							{
								"source": {
									"name": "UPDATE_DATE_TIME",
									"type": "DateTime",
									"physicalType": "datetime"
								},
								"sink": {
									"name": "UPDATE_DATE_TIME",
									"type": "DateTime",
									"physicalType": "datetime2"
								}
							}
						],
						"typeConversion": true,
						"typeConversionSettings": {
							"allowDataTruncation": true,
							"treatBooleanAsNumber": false
						}
					}
				},
				"inputs": [
					{
						"referenceName": "ds_ASQLDB",
						"type": "DatasetReference",
						"parameters": {
							"SCHEMA": "STAGE_LOAD",
							"TABLE_NAME": "TD_DPDB_ADVISER_FIRM_STG",
							"ENVIRONMENT": {
								"value": "@pipeline().globalParameters.ENVIRONMENT",
								"type": "Expression"
							},
							"LOGICAL_ENVIRONMENT": {
								"value": "@pipeline().globalParameters.LOGICAL_ENVIRONMENT",
								"type": "Expression"
							},
							"SHORT_LOCATION": {
								"value": "@pipeline().globalParameters.SHORT_LOCATION",
								"type": "Expression"
							}
						}
					}
				],
				"outputs": [
					{
						"referenceName": "ds_ASQLDB",
						"type": "DatasetReference",
						"parameters": {
							"SCHEMA": "STAGE_CDI",
							"TABLE_NAME": "DPDB_ADVISER_FIRM_STG",
							"ENVIRONMENT": {
								"value": "@pipeline().globalParameters.ENVIRONMENT",
								"type": "Expression"
							},
							"LOGICAL_ENVIRONMENT": {
								"value": "@pipeline().globalParameters.LOGICAL_ENVIRONMENT",
								"type": "Expression"
							},
							"SHORT_LOCATION": {
								"value": "@pipeline().globalParameters.SHORT_LOCATION",
								"type": "Expression"
							}
						}
					}
				]
			}
		],
		"annotations": []
	}
}